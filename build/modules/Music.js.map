{"version":3,"sources":["../../src/modules/Music.js"],"names":["requirements","request","require","table","Music","constructor","configDB","videoInfo","authJSON","musicDB","MusicPlayer","adaptersArray","adapters","players","regionCode","apiKey","get","startConnections","forEach","a","ready","getAll","serverIds","then","queues","console","log","queue","guild","getGuild","id","voice","getChannel","voice_id","text","text_id","player","getCachingInfoLink","push","getStreamUrl","info","link","hashedLink","createHash","update","digest","getCachingInfoHash","cachedInfo","getVid","getVideoInfo","saveVid","cachingSearch","string","cache","getSearch","response","search","saveSearch","catch","error","Promise","resolve","reject","requestUrl","method","uri","gzip","JSON","parse","body"],"mappings":"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","file":"Music.js","sourcesContent":["/**\r\n * Created by macdja38 on 2016-11-26.\r\n */\r\n\"use strict\";\r\nimport \"babel-core/register\";\r\nimport \"source-map-support/register\";\r\nimport crypto from \"crypto\";\r\n\r\nimport Module from \"./Module\";\r\n\r\nlet requirements = [\"configDB\", \"musicDB\", \"configJSON\", \"musicPlayer\"];\r\n\r\nlet request = require(\"request\");\r\n\r\nlet table = \"music\";\r\n\r\nexport class Music extends Module {\r\n  constructor({ configDB, videoInfo, authJSON, musicDB, MusicPlayer, adaptersArray }) {\r\n    super();\r\n    this.adapters = adaptersArray;\r\n    this.MusicPlayer = MusicPlayer;\r\n    this.musicDB = musicDB;\r\n    this.videoInfo = videoInfo;\r\n    this.players = [];\r\n    this.regionCode = \"CA\";\r\n    this.apiKey = authJSON.get(\"apiKeys.youtube\", false);\r\n    this.startConnections();\r\n  }\r\n\r\n  startConnections() {\r\n    this.adapters.forEach(async a => {\r\n      await a.ready;\r\n      this.musicDB.getAll(...a.serverIds).then(queues => {\r\n        queues.forEach(queue => {\r\n          console.log(queue);\r\n          let guild = a.getGuild(queue.id);\r\n          if (!guild) return;\r\n          let voice = guild.getChannel(queue.voice_id);\r\n          let text = guild.getChannel(queue.text_id);\r\n          if (!text || !voice) return;\r\n          let player = new this.MusicPlayer(a, guild, text, voice, queue.queue, this.musicDB, this);\r\n          // player.init(voice.id);\r\n          //this.cachingSearch(\"rock and roll\");\r\n          this.getCachingInfoLink(\"https://www.youtube.com/watch?v=yprjgWwGd1w\");\r\n          this.players.push(player);\r\n        })\r\n      })\r\n    })\r\n  }\r\n\r\n  getStreamUrl(info) {\r\n    return this.videoInfo.getStreamUrl(info);\r\n  }\r\n\r\n  async getCachingInfoLink(link) {\r\n    let hashedLink = crypto.createHash(\"sha256\").update(link).digest(\"hex\");\r\n    return this.getCachingInfoHash(hashedLink, link)\r\n  }\r\n\r\n  async getCachingInfoHash(hashedLink, link) {\r\n    let cachedInfo = await this.musicDB.getVid(hashedLink);\r\n    console.log(\"cachedInfo\", cachedInfo);\r\n    if (cachedInfo) return cachedInfo;\r\n    let info = await this.videoInfo.getVideoInfo(link);\r\n    console.log(\"fetchedInfo\", info);\r\n    this.musicDB.saveVid(hashedLink, link, info);\r\n    return info;\r\n  }\r\n\r\n  async cachingSearch(string) {\r\n    let cache = await this.musicDB.getSearch(string);\r\n    if (cache) {\r\n      console.log(\"Cached\", cache);\r\n      return cache;\r\n    }\r\n    let response = await this.search(string);\r\n    this.musicDB.saveSearch(string, response).catch(error => console.error);\r\n    console.log(response);\r\n    return response;\r\n  }\r\n\r\n  search(string) {\r\n    return new Promise((resolve, reject) => {\r\n      let requestUrl = \"https://www.googleapis.com/youtube/v3/search\" +\r\n        `?part=snippet&q=${string}&key=${this.apiKey}&regionCode=${this.regionCode}`;\r\n      request({method: \"GET\", uri: requestUrl, gzip: true}, (error, response) => {\r\n        if (error) reject(error);\r\n        resolve(JSON.parse(response.body));\r\n      })\r\n    })\r\n  }\r\n}\r\n\r\nexport default Music;"]}