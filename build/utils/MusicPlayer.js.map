{"version":3,"sources":["../../src/utils/MusicPlayer.js"],"names":["MusicPlayer","constructor","adapter","guild","text","voice","queue","musicDB","music","_adapter","_musicDB","repeat","fallbackQueue","ready","connecting","currentSong","songStartTime","Date","now","length","init","id","then","play","saveQueue","guild_name","name","text_id","voice_id","addListeners","connection","oldConnection","removeListeners","on","onEnd","bind","onWarn","onDebug","onDisconnect","removeListener","queueRandomPlaylist","playlist","getCachedDiscordFMPlaylist","console","log","newSong","Math","floor","random","push","link","url","user","args","error","lastVideo","shift","disconnect","channel","joinVoiceChannel","add","user_id","user_name","getStreamUrl","getCachingInfoLink","result","encoderArgs","pause"],"mappings":"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","file":"MusicPlayer.js","sourcesContent":["/**\r\n * Created by macdja38 on 2016-11-26.\r\n */\r\n\"use strict\";\r\nimport \"babel-core/register\";\r\nimport \"source-map-support/register\";\r\n\r\nexport class MusicPlayer {\r\n  constructor(adapter, guild, text, voice, queue, musicDB, music) {\r\n    this._adapter = adapter;\r\n    this._musicDB = musicDB;\r\n    this.music = music;\r\n    this.guild = guild;\r\n    this.text = text;\r\n    this.voice = voice;\r\n    this.queue = queue;\r\n    this.repeat = false;\r\n    this.fallbackQueue = \"electro-hub\";\r\n    this.ready = false;\r\n    this.connecting = false;\r\n    this.currentSong = false;\r\n    this.songStartTime = Date.now();\r\n    if (queue && queue.length > 0) {\r\n      this.init(voice.id).then(() => {\r\n        this.play();\r\n      })\r\n    }\r\n  }\r\n\r\n  saveQueue() {\r\n    this._musicDB.saveQueue({\r\n      id: this.guild.id,\r\n      guild_name: this.guild.name,\r\n      text: this.text.name,\r\n      text_id: this.text.id,\r\n      voice: this.voice.name,\r\n      voice_id: this.voice.id,\r\n    }, this.queue)\r\n  }\r\n\r\n  addListeners(connection, oldConnection) {\r\n    if (oldConnection) {\r\n      this.removeListeners(oldConnection);\r\n    }\r\n    connection.on(\"end\", this.onEnd.bind(this));\r\n    connection.on(\"warn\", this.onWarn.bind(this));\r\n    connection.on(\"debug\", this.onDebug.bind(this));\r\n    connection.on(\"disconnect\", this.onDisconnect.bind(this));\r\n  }\r\n\r\n  removeListeners(oldConnection) {\r\n    oldConnection.removeListener(\"end\", this.onEnd);\r\n    oldConnection.removeListener(\"warn\", this.onWarn);\r\n    oldConnection.removeListener(\"debug\", this.onDebug());\r\n    oldConnection.removeListener(\"disconnect\", this.onDisconnect());\r\n  }\r\n\r\n  async queueRandomPlaylist(id) {\r\n    let playlist = await this.music.getCachedDiscordFMPlaylist(id);\r\n    console.log(\"playlist\", playlist);\r\n    let newSong = playlist.playlist[Math.floor(Math.random() * playlist.playlist.length)];\r\n    this.queue.push({link: newSong.url, user: \"103607047383166976\"});\r\n  }\r\n\r\n  async onEnd(...args) {\r\n    console.error(...args);\r\n    let lastVideo = this.queue.shift();\r\n    if (this.repeat) this.queue.push(lastVideo);\r\n    else if (this.fallbackQueue) {\r\n      await this.queueRandomPlaylist(this.fallbackQueue);\r\n    }\r\n    if (this.queue.length > 0) {\r\n      this.play();\r\n    }\r\n  }\r\n\r\n  onWarn(...args) {\r\n    console.error(\"Warn\", ...args);\r\n  }\r\n\r\n  onDebug(...args) {\r\n    console.error(\"Debug\", ...args);\r\n  }\r\n\r\n  onDisconnect(...args) {\r\n    console.error(\"Disconnected\", ...args);\r\n    this.connection.disconnect(null, true);\r\n  }\r\n\r\n  async init(channel) {\r\n    return this._adapter.joinVoiceChannel(channel).then(connection => {\r\n      let oldConnection = this.connection;\r\n      this.connection = connection;\r\n      this.addListeners(connection, oldConnection);\r\n    });\r\n  }\r\n\r\n  add(link, user) {\r\n    this.queue.push({link, user_id: user.id, user_name: user.name});\r\n    this.saveQueue();\r\n  }\r\n\r\n  async play() {\r\n    if (this.queue.length > 0) {\r\n      console.log(\"queue\", this.queue);\r\n      let url;\r\n      try {\r\n        url = this.music.getStreamUrl(await this.music.getCachingInfoLink(this.queue[0].link));\r\n      } catch (error) {\r\n        this.onEnd();\r\n        return;\r\n      }\r\n      console.log(\"Attempting to play \" , url);\r\n      console.log(\"Current connection status Ready:\", this.connection.ready, \" connecting:\", this.connection.connecting);\r\n      let result = await this.connection.play(url.url, {encoderArgs: [\"-c\", \"copy\"]});\r\n      console.log(\"Play result \", result);\r\n      this.songStartTime = Date.now();\r\n    }\r\n  }\r\n\r\n  pause() {\r\n\r\n  }\r\n}\r\n\r\nexport default MusicPlayer;\r\n"]}