{"version":3,"sources":["../../src/utils/videoInfo.js"],"names":["getVideoInfo","fetchWithYtdl","fetchWithYoutubeDl","getStreamUrl","youtubeDl","require","ytdl","idealFormatIds","link","args","indexOf","catch","Promise","resolve","reject","getInfo","err","info","maxBuffer","getEncoding","encoding","audioEncoding","acodec","getContainer","ext","container","getFormatId","itag","format_id","isEncodedAs","isContainer","streamableSource","formats","sourceURL","webpage_url","loaderUrl","formatMap","map","f","console","log","format","url","opusItems","filter","webMOpusItems","length","sortedwebMOpusItems","sort","a","b","abr","audioBitrate","raven","process","nextTick","toObj","chosen","find","resolution","captureException","extra","level","arr","reduce","o","v","i"],"mappings":"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","file":"videoInfo.js","sourcesContent":["/**\r\n * Created by macdja38 on 2016-11-27.\r\n */\r\n\r\n/**\r\n * Created by meew0 on 2015-011-27.\r\n */\r\n\"use strict\";\r\n\r\nlet youtubeDl = require('youtube-dl');\r\nlet ytdl = require('ytdl-core');\r\n\r\n// formats in order of preference when streaming them\r\n// starting numbers are itag values for youtube https://en.wikipedia.org/wiki/YouTube#Quality_and_formats\r\nlet idealFormatIds = [\"249\", \"250\", \"251\", \"171\", \"140\", \"141\", \"127\", \"128\", \"82\", \"83\", \"100\", \"84\", \"85\", \"5\", \"18\", \"43\", \"22\", \"36\", \"17\", \"http_mp3_128_url\"];\r\n\r\nexport function getVideoInfo(link) {\r\n  if (args[0].indexOf(\"youtu\") > -1) {\r\n    return fetchWithYtdl(link).catch(() => fetchWithYoutubeDl(link));\r\n  } else {\r\n    return fetchWithYoutubeDl(link);\r\n  }\r\n}\r\n\r\nexport function fetchWithYtdl(link) {\r\n  return new Promise((resolve, reject)=> {\r\n    ytdl.getInfo(link, [], (err, info) => {\r\n      if (err) {\r\n        reject(err);\r\n      } else {\r\n        resolve(info);\r\n      }\r\n    })\r\n  });\r\n}\r\n\r\nexport function fetchWithYoutubeDl(link) {\r\n  return new Promise((resolve, reject)=> {\r\n    youtubeDl.getInfo(link, [], {maxBuffer: 1000 * 1024}, (err, info) => {\r\n      if (err) {\r\n        reject(err);\r\n      }\r\n      else {\r\n        resolve(info);\r\n      }\r\n    });\r\n  })\r\n}\r\n\r\nfunction getEncoding(info) {\r\n  return info.encoding || info.audioEncoding || info.acodec;\r\n}\r\n\r\nfunction getContainer(info) {\r\n  return info.ext || info.container;\r\n}\r\n\r\nfunction getFormatId(info) {\r\n  return info.itag || info.format_id;\r\n}\r\n\r\nfunction isEncodedAs(info, encoding) {\r\n  return getEncoding(info) === encoding;\r\n}\r\n\r\nfunction isContainer(info, container) {\r\n  return getContainer(info) === container;\r\n}\r\n\r\nexport function getStreamUrl(info) {\r\n  // first round, extract anything with opus and feed that through.\r\n  let streamableSource = {};\r\n  let formats = info.formats;\r\n  streamableSource.sourceURL = this.info.webpage_url || this.info.loaderUrl;\r\n  // try and just use itag values\r\n  let formatMap = formats.map(f => getFormatId(f));\r\n  for (let itag of idealFormatIds) {\r\n    if (formatMap.indexOf(itag) > -1) {\r\n      console.log(\"found based on itag\");\r\n      let format = formats[formatMap.indexOf(itag)];\r\n      streamableSource.encoding = getEncoding(format);\r\n      streamableSource.container = getContainer(format);\r\n      streamableSource.url = format.url;\r\n      return streamableSource;\r\n    }\r\n  }\r\n\r\n  let opusItems = this.info.formats\r\n    .filter(f => isEncodedAs(f, \"opus\"));\r\n  let webMOpusItems = opusItems.filter(f => isContainer(f, \"webm\"));\r\n  if (webMOpusItems.length > 0) {\r\n    streamableSource.encoding = \"opus\";\r\n    streamableSource.container = \"webm\";\r\n    let sortedwebMOpusItems = webMOpusItems.sort((a, b) => (b.abr || b.audioBitrate) - (a.abr || a.audioBitrate));\r\n    streamableSource.url = sortedwebMOpusItems[0].url;\r\n    console.log(\"Found webm/opus\");\r\n    if (this.raven) {\r\n      process.nextTick(() => {\r\n        let formats = toObj(this.info.formats);\r\n        formats.chosen = streamableSource;\r\n      });\r\n    }\r\n    return streamableSource;\r\n  }\r\n\r\n  // let oggItems = opusItems.filter(f => isContainer(f, \"ogg\"));\r\n\r\n  // second round, capture anything with a bitrate and no resolution\r\n  formats = this.info.formats\r\n    .sort((a, b) => b.abr - a.abr);\r\n  if (formats.length > 0) {\r\n    let format = (formats.find(f => (f.abr || f.audioBitrate) > 0 && !f.resolution) || formats.find(f => (f.abr || f.audioBitrate) > 0));\r\n    if (format) {\r\n      streamableSource.url = format.url;\r\n      streamableSource.container = getContainer(format);\r\n      streamableSource.encoding = getEncoding(format);\r\n      console.log(\"defaulted to other \", streamableSource.container, streamableSource.encoding);\r\n      if (this.raven) {\r\n        process.nextTick(() => {\r\n          let formats = toObj(this.info.formats);\r\n          formats.chosen = streamableSource;\r\n        });\r\n      }\r\n      return streamableSource;\r\n    }\r\n\r\n\r\n    // 3rd round, extract mp3's and return those.\r\n    format = formats.find(f => isContainer(f, \"mp3\"));\r\n    if (format) {\r\n      streamableSource.url = format.url;\r\n      streamableSource.container = getContainer(format);\r\n      streamableSource.encoding = getEncoding(format);\r\n      console.log(\"defaulted to other \", streamableSource.container, streamableSource.encoding);\r\n      if (this.raven) {\r\n        process.nextTick(() => {\r\n          let formats = toObj(this.info.formats);\r\n          formats.chosen = streamableSource;\r\n        });\r\n      }\r\n      return streamableSource;\r\n    }\r\n  }\r\n  if (this.raven) {\r\n    this.raven.captureException(\"Could not find a format to queue\", {\r\n      extra: toObj(this.info.formats),\r\n      level: \"error\"\r\n    });\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction toObj(arr) {\r\n  return arr.reduce(function (o, v, i) {\r\n    o[i] = v;\r\n    return o;\r\n  }, {});\r\n}"]}